---
title: 'Testing external contributions using GitHub Actions secrets'
date: 2023-04-20
description: >
  Learn how to test open source contributors' pull requests using GitHub Actions
  secrets, securely.
descriptionLong: >
  Testing external open source contributors' pull requests using GitHub Actions
  secrets is no easy feat, but we've found a way of doing so securely and
  without sacrificing convenience.
picture: 2023-04-20/octocat-padlock-illustration.png
pictureComment:
  Header image generated by [DALL·E 2](https://openai.com/dall-e-2)
commentsUrl: https://discuss.dvc.org/t/blog-testing-external-contributions-using-github-actions-secrets/1613
authors:
  - '0x2b3bfa0'
tags:
  - Engineering
  - Open Source
  - CI/CD
  - Security
  - GitHub
  - Company
---

As cloud-native applications become more complex and rely on more third-party
services, testing becomes increasingly difficult. One of the most significant
challenges for open source projects is testing contributions against complex
services that require authentication and are particularly hard to mock.

In this blog post, we will explore a simple method for securely running this
kind of integration tests on external pull requests, using the GitHub Actions
[`pull_request_target` trigger](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request_target)
and GitHub
[environments](https://docs.github.com/en/actions/deployment/targeting-different-environments)
to prevent unauthorized runs:

## Configuration

1. [Create some encrypted secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets#creating-encrypted-secrets-for-a-repository);
   a secret named **`EXAMPLE`** will be used to illustrate the next sections.
2. [Create an environment](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment#creating-an-environment)
   named `external` and add some trusted GitHub users or
   [teams](https://docs.github.com/en/organizations/organizing-members-into-teams/about-teams)
   as
   [required reviewers](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment#required-reviewers);
   they’ll be responsible for approving every run triggered by external
   contributors.

   ![screenshot of environment settings](../uploads/images/2023-04-20/environment.jpg)

## Workflow

> ⚠️ **Warning**: using the
> [`pull_request_target`](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request_target)
> event without the cautionary measures described below may allow unauthorized
> GitHub users to open a “pwn request” and exfiltrate secrets; see also this
> [[1](https://securitylab.github.com/research/github-actions-preventing-pwn-requests),
> [2](https://securitylab.github.com/research/github-actions-untrusted-input),
> [3](https://securitylab.github.com/research/github-actions-building-blocks)]
> blog post series from GitHub Security Lab and
> [this](https://stackoverflow.com/a/71366152/4654476) Stack Overflow answer.

```yaml
on: pull_request_target

jobs:
  authorize:
    environment:
      ${{ github.event_name == 'pull_request_target' &&
      github.event.pull_request.head.repo.full_name != github.repository &&
      'external' || 'internal' }}
    runs-on: ubuntu-latest
    steps:
      - run: true

  test:
    needs: authorize
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
      - run: printenv EXAMPLE
        env:
          EXAMPLE: ${{ secrets.EXAMPLE }}
```

This workflow will be triggered by the
[`pull_request_target`](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request_target)
event, which is
[similar](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onpushpull_requestpull_request_targetpathspaths-ignore)
to the
[`pull_request`](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request)
event, but it always passes secrets to workflows triggered from fork pull
requests.

The `authorize` job checks if the workflow was triggered from a fork pull
request. In that case, the `external` environment will prevent the job from
running until it’s approved. Otherwise (i.e. when pull requests belong to the
main repository), the job will run without requiring explicit approval.

The `test` job is where secrets would be used. It
[`needs`](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idneeds)
the previous job, so it will never run without explicit approval. The security
of this approach is based on the idea of a human approving every run after
making sure that there is no malicious code on them, hence it also overrides
[the `ref` from `actions/checkout`](https://github.com/actions/checkout#checkout-a-different-branch)
to run on the pull request branch rather than on the main branch.

## Alternatives

Admittedly, adding this `authorize` job to the workflow isn’t particularly
elegant but, as of January 2023, GitHub doesn’t provide any official guidance on
how to achieve a similar result in simpler ways.

- In 2020, GitHub
  [introduced](https://github.blog/2020-08-03-github-actions-improvements-for-fork-and-pull-request-workflows/)
  an option to send secrets to workflows from fork pull requests, but it only
  has effect on fork pull requests from private repositories.
- In 2021, GitHub
  [introduced](https://github.blog/2021-04-22-github-actions-update-helping-maintainers-combat-bad-actors/)
  an option to
  [require approval for all the outside collaborators](https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/enabling-features-for-your-repository/managing-github-actions-settings-for-a-repository#configuring-required-approval-for-workflows-from-public-forks),
  but the `pull_request_target` event will trigger
  [regardless of the approval settings](https://docs.github.com/en/enterprise-cloud@latest/actions/managing-workflow-runs/approving-workflow-runs-from-public-forks#about-workflow-runs-from-public-forks).

Other common alternatives include: skipping tests that need access to secrets,
disabling forks, and using pull request labels or code review approvals to
control the execution of tests.

## Security Testing

This approach has been tested by sporadic security researchers who found our
repositories while looking for the `pull_request_target` trigger, but none of
them ([#1130](https://github.com/iterative/cml/pull/1130)
[[1](https://marcyoung.us/post/zuckerpunch)] &
[#1322](https://github.com/iterative/cml/pull/1322)) were able to bypass this
protection. If you find out a way of bypassing it, please feel free to put
[our bug bounty program](https://iterative.ai/security-and-privacy/) to good
use.

---

Now you have it! As far as we know, this is currently the most elegant GitHub
Actions configuration for testing pull requests from public repository forks
using secrets. As maintainers of a lot of open source software, this is close to
our hearts!

Here are some example usages for
[cml](https://github.com/iterative/cml/blob/1be24edaa817de320a657ec3ad1182e145aecef7/.github/workflows/test-deploy.yml#L13-L20)
and
[mlem](https://github.com/iterative/mlem/blob/462384ee7a9fc50196e06942684171e9915f46ae/.github/workflows/check-test-release.yml#L13-L25).

_Do you have any better alternative or maybe a similar use case and want to
discuss more? Join us in [Discord](https://discord.com/invite/dvwXA2N)!_
